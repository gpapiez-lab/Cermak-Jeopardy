<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Jeopardy + Firebase Buzzer</title>
  <script src="https://cdn.jsdelivr.net/npm/qrcodejs@1.0.0/qrcode.min.js"></script>
  <style>
    :root{--bg:#0b1020;--panel:#111a33;--tile:#17306e;--tile2:#10265c;--accent:#f7c948;--text:#e9eefc;--muted:#a9b5d6;--danger:#ff5d5d;--good:#46d39a;--border:rgba(255,255,255,.12);--shadow:0 10px 30px rgba(0,0,0,.35);--radius:16px;--font:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif;}
    *{box-sizing:border-box}
    body{margin:0;font-family:var(--font);background:radial-gradient(1200px 800px at 20% 10%, #1a2a66 0%, var(--bg) 50%, #070a14 100%);color:var(--text);min-height:100vh;padding:18px;}
    header{display:flex;align-items:center;justify-content:space-between;gap:12px;margin:0 auto 14px;max-width:1200px;}
    h1{font-size:20px;margin:0;letter-spacing:.5px}
    .sub{color:var(--muted);font-size:13px}
    .controls{display:flex;gap:10px;flex-wrap:wrap;justify-content:flex-end}
    button{background:linear-gradient(180deg,#1c2f72,#13265e);color:var(--text);border:1px solid var(--border);border-radius:999px;padding:10px 14px;cursor:pointer;box-shadow:var(--shadow);font-weight:600;}
    button:hover{filter:brightness(1.06)} button:active{transform:translateY(1px)}
    button.secondary{background:transparent;box-shadow:none}
    button.danger{background:linear-gradient(180deg,#7a1b1b,#4a0f0f)}
    button.good{background:linear-gradient(180deg,#146b4b,#0b3d2a)}
    main{max-width:1200px;margin:0 auto;display:grid;grid-template-columns:1fr;gap:14px;}
    .row2{display:grid;grid-template-columns:1.2fr .8fr;gap:14px}
    @media (max-width:980px){.row2{grid-template-columns:1fr}}
    .panel{background:rgba(17,26,51,.78);border:1px solid var(--border);border-radius:var(--radius);padding:12px;box-shadow:var(--shadow);}
    .scoreboard{display:flex;align-items:center;justify-content:space-between;gap:12px;flex-wrap:wrap;}
    .teams{display:flex;gap:10px;flex-wrap:wrap}
    .team{background:rgba(255,255,255,.05);border:1px solid var(--border);border-radius:14px;padding:10px 12px;min-width:180px;}
    .team .name{display:flex;align-items:center;justify-content:space-between;gap:8px;font-weight:800}
    .team .score{font-size:20px;color:var(--accent)}
    .team .adj{display:flex;gap:8px;margin-top:10px;flex-wrap:wrap}
    .board{display:grid;gap:10px;background:rgba(17,26,51,.55);border:1px solid var(--border);border-radius:var(--radius);padding:12px;box-shadow:var(--shadow);overflow:auto;}
    .cell{border-radius:14px;border:1px solid var(--border);background:linear-gradient(180deg,var(--tile),var(--tile2));padding:10px;min-height:72px;display:flex;align-items:center;justify-content:center;text-align:center;user-select:none;position:relative;}
    .cell.category{background:linear-gradient(180deg,#2a3f8f,#1b2f74);font-weight:900;letter-spacing:.4px;text-transform:uppercase;font-size:13px;}
    .cell.question{cursor:pointer;font-weight:900;font-size:20px;color:var(--accent);}
    .cell.question.used{cursor:not-allowed;filter:grayscale(.9) brightness(.75);color:rgba(247,201,72,.35);}
    .cell.question.cell-hidden{color:transparent;user-select:none;}
    .badge{position:absolute;top:8px;right:8px;font-size:11px;color:#0b1020;background:var(--accent);padding:3px 8px;border-radius:999px;font-weight:900;}
    .pill{display:inline-flex;padding:8px 12px;border-radius:999px;border:1px solid var(--border);background:rgba(255,255,255,.05);font-weight:700;color:var(--muted);gap:8px;align-items:center;}
    .small{font-size:12px;color:var(--muted)}
    .mono{font-family:ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,monospace}
    .overlay{position:fixed;inset:0;background:rgba(0,0,0,.70);display:none;align-items:center;justify-content:center;padding:18px;z-index:50;}
    .overlay.show{display:flex}
    .modal{width:min(820px,100%);background:rgba(17,26,51,.94);border:1px solid var(--border);border-radius:22px;box-shadow:var(--shadow);padding:16px;}
    /* Question modal: maximized, images first then question in yellow */
    #qOverlay .modal{width:94vw;max-width:none;height:92vh;max-height:92vh;overflow:auto;padding:20px;}
    #qOverlay .modal header{margin-bottom:12px;}
    #qOverlay .modal h2{font-size:clamp(18px,2.2vw,24px);}
    #qOverlay .q-clue-images{margin:0 0 24px 0;gap:20px;min-height:0;}
    #qOverlay .q-clue-images img{max-height:min(680px,72vh);max-width:100%;}
    #qOverlay .q-prompt{margin:0 0 14px 0;font-size:clamp(28px,3.6vw,48px);font-weight:900;line-height:1.35;text-align:center;padding:24px;border-radius:18px;border:1px solid var(--border);background:rgba(0,0,0,.25);color:#f7c948;white-space:pre-line;}
    #qOverlay .q-meta-pills{display:flex;flex-wrap:wrap;gap:10px;justify-content:center;align-items:center;margin:0 0 14px 0;}
    .modal header{max-width:none;margin:0;padding:0 0 10px 0;display:flex;align-items:center;justify-content:space-between;gap:12px}
    .modal h2{margin:0;font-size:16px}
    .meta{color:var(--muted);font-size:13px}
    .prompt{margin:14px 0;font-size:28px;font-weight:900;line-height:1.15;text-align:center;padding:18px;border-radius:18px;border:1px solid var(--border);background:rgba(0,0,0,.18);}
    .q-clue-images{display:flex;flex-wrap:wrap;gap:12px;justify-content:center;margin:10px 0;}
    .q-clue-images:not(:has(img[src])){display:none;}
    .q-clue-images img{display:none;max-width:100%;max-height:280px;object-fit:contain;border-radius:12px;border:1px solid var(--border);}
    .q-clue-images img[src]{display:block;}
    .reveal{margin:12px auto 0;max-width:740px;display:none;border-top:1px solid var(--border);padding-top:12px;}
    .reveal.show{display:block}
    .reveal .label{color:var(--muted);font-size:12px;text-transform:uppercase;letter-spacing:.4px}
    .reveal .answer{font-size:20px;font-weight:800;margin-top:6px}
    .actions{display:flex;gap:10px;flex-wrap:wrap;justify-content:space-between;margin-top:14px;}
    .actions .left,.actions .right{display:flex;gap:10px;flex-wrap:wrap}
    .final-grid{display:grid;gap:10px;grid-template-columns:repeat(auto-fit,minmax(220px,1fr));}
    .final-card{background:rgba(255,255,255,.05);border:1px solid var(--border);border-radius:18px;padding:12px;}
    .final-card .tname{font-weight:900}
    .final-card .tscore{color:var(--accent);font-weight:900}
    .final-card label{display:block;color:var(--muted);font-size:12px;margin-top:10px}
    .final-card input{width:100%;background:rgba(0,0,0,.18);color:var(--text);border:1px solid var(--border);border-radius:12px;padding:10px 10px;margin-top:6px;}

    /* Fullscreen QR modal */
    #qrModal {
      width: 96vw;
      height: 92vh;
      max-width: none;
      display:flex;
      flex-direction:column;
      align-items:center;
      justify-content:center;
      text-align:center;
    }
    #qrCanvas {
      width: min(82vmin, 980px);
      height: min(82vmin, 980px);
      background:#fff;
      padding:18px;
      border-radius:22px;
      border:1px solid rgba(0,0,0,.25);
    }

    /* Splash Screen */
    #splashScreen {
      position: fixed;
      inset: 0;
      background: url('Cermak Jeopardy splash.png') center/cover no-repeat;
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 100;
      transition: opacity 0.5s ease-out;
    }
    #splashScreen.hidden {
      opacity: 0;
      pointer-events: none;
    }
    #startButton {
      position: absolute;
      bottom: 2%;
      left: 50%;
      transform: translateX(-50%);
      background: linear-gradient(180deg, #f7c948, #d4a83a);
      color: #0b1020;
      border: 3px solid #fff;
      border-radius: 999px;
      padding: 20px 60px;
      font-size: 32px;
      font-weight: 900;
      cursor: pointer;
      box-shadow: 0 10px 30px rgba(0,0,0,.5), 0 0 20px rgba(247,201,72,.5);
      text-transform: uppercase;
      letter-spacing: 2px;
      transition: all 0.2s;
    }
    #startButton:hover {
      transform: translateX(-50%) scale(1.05);
      box-shadow: 0 15px 40px rgba(0,0,0,.6), 0 0 30px rgba(247,201,72,.7);
    }
    #startButton:active {
      transform: translateX(-50%) scale(0.98);
    }

    /* Splash: Start button centered at bottom */
    #splashButtons {
      position: absolute;
      bottom: 2%;
      left: 50%;
      transform: translateX(-50%);
      z-index: 2;
    }
    #splashButtons #startButton {
      position: static;
      transform: none;
    }
    #splashButtons #startButton:hover {
      transform: scale(1.05);
    }
    #splashButtons #startButton:active {
      transform: scale(0.98);
    }
    /* Testing Environment: top right, separate from main flow */
    #testingEnvButton {
      position: absolute;
      top: 16px;
      right: 16px;
      z-index: 2;
      background: linear-gradient(180deg, #1a3a8a, #0f2560);
      color: #e9eefc;
      border: 3px solid #3b82f6;
      border-radius: 999px;
      padding: 14px 28px;
      font-size: 18px;
      font-weight: 900;
      cursor: pointer;
      box-shadow: 0 8px 24px rgba(0,0,0,.5), 0 0 16px rgba(59,130,246,.4);
      text-transform: uppercase;
      letter-spacing: 1px;
      transition: all 0.2s;
    }
    #testingEnvButton:hover {
      transform: scale(1.05);
      box-shadow: 0 12px 32px rgba(0,0,0,.6), 0 0 24px rgba(59,130,246,.5);
    }
    #testingEnvButton:active {
      transform: scale(0.98);
    }

    /* Hide main content until game starts */
    body.game-started header,
    body.game-started main {
      display: block;
    }
    body:not(.game-started) header,
    body:not(.game-started) main {
      display: none;
    }

    /* Buzz-in splash (CERMAK Jeopardy style) */
    #buzzInOverlay {
      position: fixed;
      inset: 0;
      background: radial-gradient(ellipse at 30% 20%, #1a2a66 0%, #0b1020 40%, #1a1a2e 70%, #16213e 100%);
      background-image: 
        radial-gradient(ellipse 80% 50% at 50% 20%, rgba(247,201,72,.15) 0%, transparent 50%),
        radial-gradient(ellipse at 70% 80%, #2a1a4a 0%, transparent 40%),
        radial-gradient(1200px 800px at 20% 10%, #1a2a66 0%, #0b1020 50%, #070a14 100%);
      display: none;
      align-items: center;
      justify-content: center;
      flex-direction: column;
      padding: 24px;
      z-index: 60;
      text-align: center;
    }
    #buzzInOverlay.show { display: flex; }
    #buzzInOverlay .buzz-title {
      font-size: clamp(3.5rem, 12vw, 7rem);
      font-weight: 900;
      color: #fff;
      text-shadow: 0 0 30px rgba(247,201,72,.5);
      letter-spacing: 2px;
      margin-bottom: 8px;
    }
    #buzzInOverlay .buzz-sub {
      font-size: clamp(3.5rem, 12vw, 7rem);
      font-weight: 900;
      color: #fff;
      text-shadow: 0 0 30px rgba(247,201,72,.5);
      letter-spacing: 2px;
      margin-bottom: 32px;
    }
    #buzzInOverlay .buzz-instruction {
      font-size: clamp(1.25rem, 3.5vw, 1.75rem);
      color: var(--muted);
      max-width: 640px;
      line-height: 1.5;
    }

    /* View Categories overlay */
    #viewCategoriesOverlay {
      position: fixed;
      inset: 0;
      background: linear-gradient(135deg, #0b1020 0%, #1a2a66 50%, #0b1020 100%);
      display: none;
      align-items: center;
      justify-content: center;
      flex-direction: column;
      padding: 24px;
      z-index: 55;
    }
    #viewCategoriesOverlay.show { display: flex; }
    #viewCategoriesOverlay .category-slide {
      font-size: clamp(4rem, 18vw, 10rem);
      font-weight: 900;
      color: var(--accent);
      text-transform: uppercase;
      letter-spacing: 6px;
      transform: translateX(-100vw);
      opacity: 0;
      transition: transform 0.6s ease-out, opacity 0.5s ease-out;
      text-align: center;
      width: 100%;
    }
    #viewCategoriesOverlay .category-slide.visible {
      transform: translateX(0);
      opacity: 1;
    }
    #viewCategoriesOverlay .category-slide.exit {
      transform: translateX(100vw);
      opacity: 0;
    }
    #viewCategoriesOverlay #btnCategoryNext {
      margin-top: 48px;
      padding: 16px 48px;
      font-size: 20px;
      font-weight: 800;
    }
  </style>
</head>
<body>
<!-- Splash Screen -->
<div id="splashScreen">
  <button id="testingEnvButton">Testing Environment</button>
  <div id="splashButtons">
    <button id="startButton">Start</button>
  </div>
</div>

<!-- Audio Elements -->
<audio id="audioTheme" loop autoplay>
  <source src="Resources/jeopardy_theme.mp3" type="audio/mpeg">
</audio>
<audio id="audioCorrect">
  <source src="Resources/correct.mp3" type="audio/mpeg">
</audio>
<audio id="audioIncorrect">
  <source src="Resources/incorrect.mp3" type="audio/mpeg">
</audio>
<audio id="audioDailyDouble">
  <source src="Resources/daily_double.mp3" type="audio/mpeg">
</audio>
<audio id="audioFinalJeopardy">
  <source src="Resources/final_jeopardy.mp3" type="audio/mpeg">
</audio>
<audio id="audioQuestionSong">
  <source src="Resources/question_song.mp3" type="audio/mpeg">
</audio>
<audio id="audioTimesUp">
  <source src="Resources/times_up.mp3" type="audio/mpeg">
</audio>
<audio id="audioBoardFill">
  <source src="Resources/jeopardy-board-fill.mp3" type="audio/mpeg">
</audio>
<header>
  <div>
    <h1 id="gameTitle">Jeopardy</h1>
  </div>
  <div class="controls">
    <button class="secondary" id="btnToggleDD">Host: Show DD</button>
    <button id="btnFinal">Final Jeopardy</button>
    <button class="danger" id="btnReset">Reset Game</button>
  </div>
</header>

<main>
  <div class="row2">
    <section class="panel scoreboard" id="scoreboard"></section>

    <section class="panel">
      <div style="text-align:center;margin-bottom:12px">
        <div style="font-weight:900">Jeopardy Host Tools</div>
      </div>
      <div style="display:flex;gap:10px;flex-wrap:wrap;align-items:center;justify-content:center">
        <button id="btnNewRoom" style="display:none">New Room</button>
        <button class="secondary" id="btnShowQR">Show QR</button>
        <button class="secondary" id="btnViewCategories" style="display:none">View Categories</button>
        <button class="good" id="btnStartGame" style="display:none">Start Game</button>
        <button class="danger" id="btnResetBuzz" disabled>Reset Buzz</button>
      </div>

      <div style="margin-top:12px">
        <div class="small">Join link:</div>
        <div class="mono" id="joinLink">—</div>
      </div>

      <div style="margin-top:12px;display:flex;gap:10px;flex-wrap:wrap;align-items:center">
        <span class="pill">Status: <span id="buzzStatus">—</span></span>
        <span class="pill">Winner: <span id="buzzWinner">—</span></span>
      </div>

      <div style="margin-top:12px">
        <div class="small">Players:</div>
        <div id="playerList">—</div>
      </div>
    </section>
  </div>

  <section class="board" id="board"></section>
</main>

<!-- Question Modal -->
<div class="overlay" id="qOverlay">
  <div class="modal">
    <div id="qClueImages" class="q-clue-images">
      <img id="qClueImage1" alt="" />
      <img id="qClueImage2" alt="" />
    </div>
    <div class="prompt q-prompt" id="qPrompt"></div>

    <div class="q-meta-pills" id="qMetaPills">
      <span class="pill" id="qCategoryPill"></span>
      <span class="pill" id="qValuePill"></span>
      <span class="pill" id="qDDPill" style="display:none">Daily Double</span>
      <span class="pill" id="qActiveTeamPill"></span>
    </div>

    <div class="reveal" id="qReveal">
      <div class="label">Answer</div>
      <div class="answer" id="qAnswer"></div>
    </div>

    <div class="actions">
      <div class="right">
        <button id="btnReveal">Reveal Answer</button>
        <button class="good" id="btnCorrect">Correct (+)</button>
        <button class="danger" id="btnWrong">Wrong (-)</button>
      </div>
    </div>
  </div>
</div>

<!-- Final Jeopardy Modal -->
<div class="overlay" id="fOverlay">
  <div class="modal">
    <header>
      <div>
        <h2>Final Jeopardy</h2>
        <div class="meta" id="fMeta"></div>
      </div>
      <button class="secondary" id="btnCloseF">Close</button>
    </header>

    <div class="prompt" id="fPrompt"></div>

    <div class="final-grid" id="finalGrid"></div>

    <div class="reveal" id="fReveal">
      <div class="label">Answer</div>
      <div class="answer" id="fAnswer"></div>
    </div>

    <div class="actions">
      <div class="left"></div>
      <div class="right">
        <button id="btnRevealFinal">Reveal Answer</button>
        <button class="good" id="btnApplyFinal">Apply Wagers</button>
      </div>
    </div>

    <div class="small">Enter wagers, mark Correct/Wrong, then “Apply Wagers”.</div>
  </div>
</div>

<!-- QR Modal (Fullscreen) -->
<div class="overlay" id="qrOverlay" aria-modal="true" role="dialog">
  <div class="modal" id="qrModal">
    <header style="width:100%;max-width:1200px;display:flex;justify-content:space-between;align-items:flex-start;gap:20px;margin-bottom:20px">
      <div>
        <h2 style="font-size:20px;margin:0">Join Buzzer</h2>
        <div class="meta" style="margin-top:4px">
          Scan this QR code to join the game<br>
          <span id="qrPlayerCount" style="font-weight:700;color:var(--accent)">Waiting for players... (0/4)</span>
        </div>
      </div>
      <button class="secondary" id="btnCloseQR" style="flex-shrink:0;min-width:120px;padding:12px 24px;font-size:16px;font-weight:700">Close</button>
    </header>

    <canvas id="qrCanvas"></canvas>

    <div class="small mono" id="qrUrlText" style="word-break:break-all;margin-top:14px;max-width:1200px">
      —
    </div>
    
    <div id="qrPlayerList" style="margin-top:14px;font-size:14px;color:var(--muted)">
      Players joined: <span id="qrPlayerNames">None yet</span>
    </div>
  </div>
</div>

<!-- Buzz-in splash (whoever buzzes first starts) -->
<div class="overlay" id="buzzInOverlay" aria-modal="true" role="dialog">
  <div style="text-align:center;max-width:720px">
    <div class="buzz-title">CERMAK Jeopardy</div>
    <div class="buzz-sub">Buzz in!</div>
    <div class="buzz-instruction">Players: tap BUZZ on your device when you're ready to be the first team to start the game.</div>
  </div>
</div>

<!-- View Categories (slide-through categories on blue screen) -->
<div id="viewCategoriesOverlay" aria-modal="true" role="dialog">
  <div id="categorySlideText" class="category-slide"></div>
  <button class="good" id="btnCategoryNext" style="display:none">Next</button>
</div>

<!-- Round 2 / Double Jeopardy transition -->
<div class="overlay" id="round2Overlay" aria-modal="true" role="dialog" style="display:none">
  <div class="modal" style="text-align:center;max-width:520px">
    <h2 style="margin:0 0 12px 0;font-size:28px;color:var(--accent)">Round 2</h2>
    <p style="color:var(--muted);margin:0 0 20px 0">Double Jeopardy — higher values!</p>
    <button class="good" id="btnRound2Continue" style="padding:14px 32px;font-size:18px">Continue</button>
  </div>
</div>

<script type="module">
  // IMPORTANT: Game initialization is deferred until Start button is clicked
  // This prevents setupTeams() from running on page load
  
  // Wait for QRCode library to be available
  function waitForQRCode() {
    return new Promise((resolve) => {
      if (typeof QRCode !== 'undefined') {
        console.log("QRCode library already loaded");
        resolve();
        return;
      }
      let attempts = 0;
      const checkInterval = setInterval(() => {
        attempts++;
        if (typeof QRCode !== 'undefined') {
          clearInterval(checkInterval);
          console.log("QRCode library loaded after", attempts * 100, "ms");
          resolve();
        } else if (attempts > 50) { // 5 seconds max wait
          clearInterval(checkInterval);
          console.warn("QRCode library did not load in time");
          resolve(); // Continue anyway
        }
      }, 100);
    });
  }

  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-app.js";
  import { getAuth, signInAnonymously } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-auth.js";
  import {
    getFirestore, doc, setDoc, updateDoc, onSnapshot,
    serverTimestamp, collection, query, onSnapshot as onSnapQuery
  } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-firestore.js";

  // Wait for QRCode to load
  await waitForQRCode();
  
  // Initialize Firebase (but don't create room yet)
  const firebaseConfig = {
    apiKey: "AIzaSyAadTD1tOCnYrqOP43dpeQpPBzlqv-JdvE",
    authDomain: "jeopardy-5956d.firebaseapp.com",
    projectId: "jeopardy-5956d",
    storageBucket: "jeopardy-5956d.firebasestorage.app",
    messagingSenderId: "979136812527",
    appId: "1:979136812527:web:904c0fc6f773f20596921a"
  };

  const app = initializeApp(firebaseConfig);
  const auth = getAuth(app);
  const db = getFirestore(app);
  await signInAnonymously(auth);

  /* ===== QR GENERATOR using qrcodejs library ===== */
let qrCodeInstance = null;

function makeQR(canvas, text) {
  try {
    // Check if QRCode library is available
    if (typeof QRCode === 'undefined') {
      console.error("QRCode library not loaded");
      return;
    }

    // Ensure text is a string
    const urlString = String(text).trim();
    if (!urlString) {
      console.error("QR code: empty text");
      return;
    }

    if (!canvas) {
      console.error("QR code: canvas element not found");
      return;
    }

    // Get the actual displayed size from CSS
    const rect = canvas.getBoundingClientRect();
    const displaySize = Math.max(200, Math.min(rect.width || 400, rect.height || 400));
    
    console.log("Generating QR code:", { url: urlString, displaySize, canvasRect: rect });
    
    // Clear canvas first
    const ctx = canvas.getContext("2d");
    canvas.width = displaySize;
    canvas.height = displaySize;
    ctx.fillStyle = "#ffffff";
    ctx.fillRect(0, 0, displaySize, displaySize);
    
    // qrcodejs library creates its own canvas, so we need to use a temporary container
    // Create or reuse a temporary container
    let tempContainer = document.getElementById('qr-temp-container');
    if (!tempContainer) {
      tempContainer = document.createElement('div');
      tempContainer.id = 'qr-temp-container';
      tempContainer.style.position = 'absolute';
      tempContainer.style.left = '-9999px';
      tempContainer.style.width = displaySize + 'px';
      tempContainer.style.height = displaySize + 'px';
      document.body.appendChild(tempContainer);
    } else {
      // Clear previous QR code
      tempContainer.innerHTML = '';
      tempContainer.style.width = displaySize + 'px';
      tempContainer.style.height = displaySize + 'px';
    }

    // Use qrcodejs library - it creates its own canvas element
    qrCodeInstance = new QRCode(tempContainer, {
      text: urlString,
      width: displaySize,
      height: displaySize,
      colorDark: "#000000",
      colorLight: "#ffffff",
      correctLevel: QRCode.CorrectLevel.M
    });

    // Wait for QR code to render, then copy to our canvas
    setTimeout(() => {
      const qrCanvas = tempContainer.querySelector('canvas');
      if (qrCanvas && canvas) {
        // Copy the QR code from the library's canvas to our canvas
        ctx.clearRect(0, 0, displaySize, displaySize);
        ctx.fillStyle = "#ffffff";
        ctx.fillRect(0, 0, displaySize, displaySize);
        ctx.drawImage(qrCanvas, 0, 0, displaySize, displaySize);
        console.log("QR code generated successfully:", { 
          url: urlString, 
          size: displaySize,
          canvasWidth: canvas.width,
          canvasHeight: canvas.height
        });
      }
    }, 100);
    
  } catch (error) {
    console.error("QR code generation exception:", error);
  }
}


  /* =========================
     GAME CONTENT (loaded from game-data.json on init)
     ========================= */
  let GAME = {
    title: "CERMAK Jeopardy",
    subtitle: "Phones buzz in → host awards points.",
    teams: [],
    values: [100,200,300,400,500],
    categories: [
      { name:"Medicine", clues:[
        { q:"This vital sign is measured in mmHg.", a:"What is blood pressure?" },
        { q:"First-line med classes often used for essential HTN.", a:"What are thiazides / ACEi/ARB / CCB (any acceptable)?" },
        { q:"ECG finding classically associated with hyperkalemia.", a:"What are peaked T waves?" },
        { q:"Score estimating stroke risk in atrial fibrillation.", a:"What is CHA₂DS₂-VASc?" },
        { q:"Daily Double: Antibiotic class of vancomycin.", a:"What is a glycopeptide?", dd:true },
      ]},
      { name:"Movies", clues:[
        { q:"He directed 'Jaws' and 'E.T.'", a:"Who is Steven Spielberg?" },
        { q:"1999 film with the 'first rule' of an underground club.", a:"What is Fight Club?" },
        { q:"Fictional African nation in Black Panther.", a:"What is Wakanda?" },
        { q:"Actor who played Joker in The Dark Knight.", a:"Who is Heath Ledger?" },
        { q:"Daily Double: 'I’ll be back' character.", a:"Who is the Terminator (T-800)?", dd:true },
      ]},
      { name:"Science", clues:[
        { q:"Force equals mass times…", a:"What is acceleration?" },
        { q:"Plants turning light into chemical energy.", a:"What is photosynthesis?" },
        { q:"Most abundant gas in Earth’s atmosphere.", a:"What is nitrogen?" },
        { q:"Negatively charged particle.", a:"What is an electron?" },
        { q:"Daily Double: SI unit of current.", a:"What is the ampere?", dd:true },
      ]},
      { name:"Food & Drink", clues:[
        { q:"Tequila + lime + triple sec cocktail.", a:"What is a Margarita?" },
        { q:"Garlic + tomatoes + basil sauce.", a:"What is marinara?" },
        { q:"Agave spirit; smoky versions often from Oaxaca.", a:"What is mezcal?" },
        { q:"Low-temp vacuum bag cooking method.", a:"What is sous vide?" },
        { q:"Daily Double: Polish dumplings.", a:"What are pierogi?", dd:true },
      ]},
      { name:"Poland", clues:[
        { q:"Capital of Poland.", a:"What is Warsaw (Warszawa)?" },
        { q:"Region known for Góralski culture.", a:"What is Podhale / Tatra region?" },
        { q:"Famous salt mine near Kraków.", a:"What is Wieliczka?" },
        { q:"Poland’s currency.", a:"What is the złoty (PLN)?" },
        { q:"Daily Double: Sea bordering northern Poland.", a:"What is the Baltic Sea?", dd:true },
      ]},
    ],
    final: { category:"Final Jeopardy", q:"This US city is known as the 'Windy City'.", a:"What is Chicago?" }
  };

  /** Load game-data.json: 2 rounds + final. Clues may have optional "image" and/or "audio" (paths under /assets). Daily Doubles assigned randomly per round, skipping first row (categories). */
  async function loadGameData() {
    try {
      const res = await fetch("game-data.json");
      if (!res.ok) throw new Error(res.statusText);
      const data = await res.json();
      GAME.title = data.title || GAME.title;
      GAME.subtitle = data.subtitle || GAME.subtitle;
      GAME.final = data.final ? { category: data.final.category || "Final Jeopardy", q: data.final.question || "", a: data.final.answer || "" } : GAME.final;
      const roundsRaw = Array.isArray(data.rounds) ? data.rounds : [];
      const defaultValues = [[100,200,300,400,500], [200,400,600,800,1000]];
      GAME.rounds = [];
      for (let roundIndex = 0; roundIndex < Math.max(2, roundsRaw.length); roundIndex++) {
        const round = roundsRaw[roundIndex] || { categories: [] };
        const values = Array.isArray(round.values) && round.values.length ? round.values : defaultValues[roundIndex] || defaultValues[0];
        const numRows = values.length;
        const ddRules = round.dailyDoubleRules || { count: roundIndex === 0 ? 1 : 2, avoidTopRow: true };
        const allClueKeys = [];
        (round.categories || []).forEach((cat, c) => {
          for (let r = 0; r < numRows; r++) allClueKeys.push({ c, r });
        });
        const ddCount = Math.min(Math.max(0, ddRules.count || 0), allClueKeys.length);
        const shuffled = [...allClueKeys].filter(({ r }) => !ddRules.avoidTopRow || r !== 0).sort(() => Math.random() - 0.5);
        const ddSet = new Set();
        for (let i = 0; i < ddCount && i < shuffled.length; i++) ddSet.add(`${shuffled[i].c}-${shuffled[i].r}`);
        const categories = (round.categories || []).map((cat, c) => {
          const rawClues = cat.clues || [];
          const clues = [];
          for (let r = 0; r < numRows; r++) {
            const clue = rawClues[r];
            if (!clue) {
              clues.push({ q: "", a: "", dd: false });
              continue;
            }
            // Support image (string), images (array of strings), or images (array of {src})
            const rawImages = clue.images || (clue.image != null ? [clue.image] : []);
            const images = [];
            for (let i = 0; i < Math.min(2, rawImages.length); i++) {
              const item = rawImages[i];
              const path = typeof item === "string" ? item : (item && item.src);
              if (path) images.push(path);
            }
            const out = {
              q: clue.question != null ? clue.question : clue.q,
              a: clue.answer != null ? clue.answer : clue.a,
              dd: ddSet.has(`${c}-${r}`)
            };
            if (images.length) out.images = images;
            if (clue.audio) out.audio = clue.audio;
            clues.push(out);
          }
          return { name: cat.name || "", clues };
        });
        GAME.rounds.push({ values, categories });
      }
      if (GAME.rounds.length === 0) {
        GAME.rounds.push({ values: defaultValues[0], categories: [] });
      }
      GAME.categories = GAME.rounds[0].categories;
      GAME.values = GAME.rounds[0].values;
      console.log("Game data loaded:", GAME.title, "rounds:", GAME.rounds.length, "round 1 categories:", GAME.categories.length);
    } catch (e) {
      console.error("Failed to load game-data.json:", e);
    }
  }

  let gameStarted = false; // Flag to prevent premature initialization
  
  function setupTeams(){
    // This function should ONLY be called when Start button is clicked
    if (!gameStarted) {
      console.warn('setupTeams called before game start - this should not happen!');
      return;
    }
    
    let count;
    do { count = parseInt(prompt("How many teams?", "4") || "", 10); }
    while(!Number.isInteger(count) || count < 1);

    const teams=[];
    for(let i=1;i<=count;i++){
      let name="";
      while(!name) name = (prompt(`Enter name for Team ${i}:`, `Team ${i}`) || "").trim();
      teams.push(name.slice(0,24));
    }
    GAME.teams = teams;
  }

  /* =========================
     BUZZER (Firestore)
     ========================= */
  const roomCodeEl = document.getElementById("roomCode");
  const joinLinkEl = document.getElementById("joinLink");
  const buzzStatusEl = document.getElementById("buzzStatus");
  const buzzWinnerEl = document.getElementById("buzzWinner");
  const playerListEl = document.getElementById("playerList");
  const btnNewRoom = document.getElementById("btnNewRoom");
  const btnResetBuzz = document.getElementById("btnResetBuzz");

  // QR UI
  const btnShowQR = document.getElementById("btnShowQR");
  const qrOverlay = document.getElementById("qrOverlay");
  const btnCloseQR = document.getElementById("btnCloseQR");
  const qrCanvas = document.getElementById("qrCanvas");
  const qrUrlText = document.getElementById("qrUrlText");
  const qrPlayerCount = document.getElementById("qrPlayerCount");
  const qrPlayerNames = document.getElementById("qrPlayerNames");

  let roomCode = null;
  let unsubRoom = null;
  let unsubPlayers = null;
  let buzzInPhaseActive = false;
  let onFirstBuzzCallback = null; // Set by game engine when buzz-in overlay is shown

  function randCode(){ return String(Math.floor(1000 + Math.random()*9000)); }

  function playerUrlWithRoom(code){
    // Ensure we create an absolute URL
    const baseUrl = window.location.origin + window.location.pathname.replace(/\/[^\/]*$/, '/');
    const u = new URL("player.html", baseUrl);
    u.searchParams.set("room", code);
    const fullUrl = u.toString();
    console.log("Generated player URL:", fullUrl);
    return fullUrl;
  }

  function setBuzzerUI({locked, winnerName, players}){
    if (locked !== undefined) buzzStatusEl.textContent = roomCode ? (locked ? "LOCKED" : "Ready") : "—";
    if (winnerName !== undefined) buzzWinnerEl.textContent = winnerName || "—";
    if (players !== undefined) playerListEl.textContent = players.length ? players.join(", ") : "—";
  }

  async function createRoom(){
    roomCode = randCode();
    console.log('Creating room:', roomCode);
    
    // Hide room code from display (keep it for Firebase functionality)
    if (roomCodeEl) roomCodeEl.textContent = ""; // Empty or hide the element
    if (joinLinkEl) joinLinkEl.textContent = playerUrlWithRoom(roomCode); // Just show URL, no room code
    if (btnResetBuzz) btnResetBuzz.disabled = false;

    const ref = doc(db, "rooms", roomCode);
    await setDoc(ref, { createdAt: serverTimestamp(), locked:false, winnerName:null, winnerUid:null });

    // Start watching the room for players
    watchRoom(roomCode);
    setBuzzerUI({locked:false, winnerName:null, players:[]});
    
    console.log('Room created and watching for players...');
  }

  let currentPlayers = []; // Track current players
  const MAX_PLAYERS = 4;

  function watchRoom(code){
    console.log('Watching room:', code);
    unsubRoom?.(); unsubPlayers?.();

    unsubRoom = onSnapshot(doc(db,"rooms",code), (snap)=>{
      if(!snap.exists()) {
        console.log('Room does not exist');
        return;
      }
      const d = snap.data();
      const locked = !!d.locked;
      const winnerName = d.winnerName ?? null;
      setBuzzerUI({ locked, winnerName });
      
      // During buzz-in phase: first player to buzz becomes active team
      if (buzzInPhaseActive && locked && winnerName && typeof onFirstBuzzCallback === 'function') {
        buzzInPhaseActive = false;
        onFirstBuzzCallback(winnerName);
      }
    });

    const playersRef = collection(db, "rooms", code, "players");
    console.log('Setting up listener for players collection:', `rooms/${code}/players`);
    
    unsubPlayers = onSnapQuery(query(playersRef), (qs)=>{
      console.log('Firebase players query result:', qs.size, 'players');
      const names=[];
      qs.forEach((docSnap)=>{
        const playerData = docSnap.data();
        const playerId = docSnap.id;
        console.log('Player document ID:', playerId, 'Data:', playerData);
        if (playerData && playerData.name) {
          names.push(playerData.name);
        }
      });
      
      console.log('Players updated:', names, 'Total:', names.length); // Debug log
      currentPlayers = names; // Update current players list
      setBuzzerUI({ players: names });
      
      // Force update QR modal display
      requestAnimationFrame(() => {
        const qrPlayerCountEl = document.getElementById("qrPlayerCount");
        const qrPlayerNamesEl = document.getElementById("qrPlayerNames");
        const btnCloseQREl = document.getElementById("btnCloseQR");
        
        console.log('Updating QR display elements:', {
          qrPlayerCountEl: !!qrPlayerCountEl,
          qrPlayerNamesEl: !!qrPlayerNamesEl,
          btnCloseQREl: !!btnCloseQREl,
          names: names
        });
        
        if (qrPlayerCountEl) {
          qrPlayerCountEl.textContent = `${names.length}/${MAX_PLAYERS} players joined`;
          if (names.length >= MAX_PLAYERS) {
            qrPlayerCountEl.textContent = `All players joined! (${MAX_PLAYERS}/${MAX_PLAYERS})`;
            qrPlayerCountEl.style.color = 'var(--good)';
          } else {
            qrPlayerCountEl.style.color = 'var(--accent)';
          }
        } else {
          console.error('qrPlayerCount element not found!');
        }
        
        if (qrPlayerNamesEl) {
          qrPlayerNamesEl.textContent = names.length > 0 ? names.join(', ') : 'None yet';
        } else {
          console.error('qrPlayerNames element not found!');
        }
        
        // Update button text based on player count
        if (btnCloseQREl) {
          if (names.length > 0) {
            btnCloseQREl.textContent = 'Start Game';
            btnCloseQREl.disabled = false;
            btnCloseQREl.style.display = 'block'; // Ensure visible
          } else {
            btnCloseQREl.textContent = 'Close';
            btnCloseQREl.disabled = false; // Allow closing even without players
            btnCloseQREl.style.display = 'block'; // Ensure visible
          }
        } else {
          console.error('btnCloseQR element not found!');
        }
        
        // Auto-close QR screen when max players reached
        if (names.length >= MAX_PLAYERS && qrOverlay && qrOverlay.classList.contains('show')) {
          setTimeout(() => {
            closeQRAndStartGame(names);
          }, 1000); // Small delay to show "All players joined" message
        }
      });
    }, (error) => {
      console.error('Error watching players:', error);
    });
  }
  
  function closeQRAndStartGame(playerNames) {
    // Stop theme music when leaving QR screen
    stopSound('theme');
    
    // Close QR overlay
    qrOverlay.classList.remove('show');
    
    // Use player names as teams
    if (playerNames && playerNames.length > 0) {
      GAME.teams = playerNames.slice(0, MAX_PLAYERS); // Limit to max players
      console.log('Teams set:', GAME.teams);
      initJeopardy(); // Shows board with hidden categories + Start Game button
    } else {
      // Just close, don't start game
      console.log('QR closed but no players to start game with');
    }
  }

  btnNewRoom.onclick = createRoom;

  const btnStartGame = document.getElementById("btnStartGame");
  const buzzInOverlay = document.getElementById("buzzInOverlay");
  if (btnStartGame && buzzInOverlay) {
    btnStartGame.onclick = async () => {
      if (!roomCode) return;
      await updateDoc(doc(db,"rooms",roomCode), { locked:false, winnerName:null, winnerUid:null });
      buzzInPhaseActive = true;
      buzzInOverlay.classList.add("show");
    };
  }

  btnResetBuzz.onclick = async ()=>{
    if(!roomCode) return;
    await updateDoc(doc(db,"rooms",roomCode), { locked:false, winnerName:null, winnerUid:null });
  };

  // Function to show QR code
  function showQRCode() {
    if (!roomCode) {
      console.error("No room code available");
      return;
    }

    // Check if QRCode library is loaded
    if (typeof QRCode === 'undefined') {
      console.error("QRCode library not found");
      alert("QR Code library not loaded. Please refresh the page.");
      return;
    }

    const url = playerUrlWithRoom(roomCode);
    qrUrlText.textContent = url;
    
    // Reset player count display
    const qrPlayerCountEl = document.getElementById("qrPlayerCount");
    const qrPlayerNamesEl = document.getElementById("qrPlayerNames");
    const btnCloseQREl = document.getElementById("btnCloseQR");
    
    if (qrPlayerCountEl) {
      qrPlayerCountEl.textContent = "Waiting for players... (0/4)";
      qrPlayerCountEl.style.color = 'var(--accent)';
    }
    if (qrPlayerNamesEl) {
      qrPlayerNamesEl.textContent = 'None yet';
    }
    if (btnCloseQREl) {
      btnCloseQREl.textContent = 'Close';
      btnCloseQREl.disabled = false; // Allow closing
    }

    qrOverlay.classList.add("show");

    // Wait for layout to settle, then draw QR code
    setTimeout(() => {
      requestAnimationFrame(() => {
        requestAnimationFrame(() => {
          makeQR(qrCanvas, url);
        });
      });
    }, 150);
  }

  // Fullscreen QR (for manual use later)
  btnShowQR.onclick = showQRCode;

  // Set up close button handler - ensure it's set up properly
  function setupCloseButton() {
    const closeBtn = document.getElementById("btnCloseQR");
    if (closeBtn) {
      // Remove any existing handlers
      closeBtn.onclick = null;
      // Add new handler
      closeBtn.onclick = (e) => {
        e.preventDefault();
        e.stopPropagation();
        console.log('Close button clicked, current players:', currentPlayers);
        
        // Host can always close QR screen
        if (currentPlayers.length > 0) {
          // Start game with current players
          console.log('Starting game with players:', currentPlayers);
          closeQRAndStartGame(currentPlayers);
        } else {
          // Just close QR screen, don't start game yet
          console.log('Closing QR screen without players');
          qrOverlay.classList.remove("show");
          // Show message that they need players
          alert('No players have joined yet. Please wait for players to join via QR code, or try scanning again.');
        }
      };
      console.log('Close button handler set up successfully');
    } else {
      console.error('btnCloseQR element not found when setting up handler!');
    }
  }
  
  // Set up immediately and also after DOM is ready
  setupCloseButton();
  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', setupCloseButton);
  }
  qrOverlay.onclick = (e)=>{ 
    // Don't close on overlay click - require button click
    e.stopPropagation();
  };
  window.addEventListener("keydown",(e)=>{ 
    if(e.key==="Escape" && qrOverlay.classList.contains("show")) {
      // Allow closing with Escape key
      if (currentPlayers.length > 0) {
        closeQRAndStartGame(currentPlayers);
      } else {
        qrOverlay.classList.remove("show");
        alert('No players have joined yet. The game will start once players join via QR code.');
      }
    }
  });

  /* =========================
     JEOPARDY ENGINE
     ========================= */
  const $ = (s)=>document.querySelector(s);
  const boardEl = $("#board");
  const scoreboardEl = $("#scoreboard");
  const qOverlay = $("#qOverlay");
  const fOverlay = $("#fOverlay");

  const state = { used:new Set(), scores:{}, activeTeam:null, showDD:false, current:null, final:{ wagers:{}, correct:{} }, categoriesRevealed:false, questionTilesRevealed:false, buzzInPhase:false, currentRound:0, testingMode:false };
  const keyOf=(c,r)=>`${c}-${r}`;
  const cssId=(s)=>s.replace(/[^a-z0-9_-]/gi,"_");
  const esc=(str)=>String(str).replace(/[&<>"']/g,m=>({ "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#039;" }[m]));
  const money=(n)=>{const m=Math.round(n); return (m<0? "-$"+Math.abs(m): "$"+m);};

  function initJeopardy(){
    $("#gameTitle").textContent = GAME.title;

    state.currentRound = 0;
    if (GAME.rounds && GAME.rounds[0]) {
      GAME.categories = GAME.rounds[0].categories;
      GAME.values = GAME.rounds[0].values;
    }
    state.used = new Set();
    GAME.teams.forEach(t=> state.scores[t]=0);
    state.activeTeam = GAME.teams[0];
    state.categoriesRevealed = false; // Hidden until first buzz
    state.buzzInPhase = false;

    // Show Start Game button (host clicks to show buzz-in splash)
    const btnStartGameEl = document.getElementById("btnStartGame");
    if (btnStartGameEl) btnStartGameEl.style.display = "inline-block";

    // When first player buzzes during buzz-in phase, this runs
    onFirstBuzzCallback = (winnerName) => {
      state.activeTeam = winnerName;
      // Keep categories and question tiles blank until View Categories + Reveal Board
      state.categoriesRevealed = false;
      state.questionTilesRevealed = false;
      const overlay = document.getElementById("buzzInOverlay");
      if (overlay) overlay.classList.remove("show");
      if (roomCode) {
        updateDoc(doc(db,"rooms",roomCode), { locked:false, winnerName:null, winnerUid:null }).catch(()=>{});
      }
      setBuzzerUI({ locked: false, winnerName: null });
      renderBoard();
      renderScoreboard();
      const btn = document.getElementById("btnStartGame");
      if (btn) btn.style.display = "none";
      const btnViewCat = document.getElementById("btnViewCategories");
      if (btnViewCat) btnViewCat.style.display = "inline-block";
      // Board reveal runs automatically with jeopardy-board-fill sound
      revealBoardAnimated();
    };

    renderScoreboard(); renderBoard(); bindUI();
  }

  /* ========== View Categories (slide-through on blue screen) ========== */
  let viewCategoriesIndex = 0;
  function openViewCategories() {
    viewCategoriesIndex = 0;
    const overlay = document.getElementById("viewCategoriesOverlay");
    const textEl = document.getElementById("categorySlideText");
    const nextBtn = document.getElementById("btnCategoryNext");
    if (!overlay || !textEl || !nextBtn) return;
    overlay.classList.add("show");
    textEl.textContent = GAME.categories[0].name;
    textEl.classList.remove("exit", "visible");
    requestAnimationFrame(() => {
      textEl.classList.add("visible");
    });
    nextBtn.style.display = "inline-block";
    nextBtn.textContent = GAME.categories.length > 1 ? "Next" : "Done";
    // Theme song plays while categories are sliding in
    playSound("theme");
  }

  function nextViewCategory() {
    const textEl = document.getElementById("categorySlideText");
    const nextBtn = document.getElementById("btnCategoryNext");
    if (!textEl || !nextBtn) return;
    textEl.classList.remove("visible");
    textEl.classList.add("exit");
    setTimeout(() => {
      viewCategoriesIndex++;
      if (viewCategoriesIndex >= GAME.categories.length) {
        // Last category done sliding in — stop theme song
        stopSound("theme");
        const overlay = document.getElementById("viewCategoriesOverlay");
        if (overlay) overlay.classList.remove("show");
        state.categoriesRevealed = true;
        renderBoard();
        nextBtn.style.display = "none";
        return;
      }
      textEl.textContent = GAME.categories[viewCategoriesIndex].name;
      textEl.classList.remove("exit", "visible"); // reset to left-offscreen
      nextBtn.textContent = viewCategoriesIndex === GAME.categories.length - 1 ? "Done" : "Next";
      requestAnimationFrame(() => {
        textEl.classList.add("visible"); // slide in left to right
      });
    }, 550);
  }

  /* ========== Reveal Board (random animated reveal, runs after first buzz) ========== */
  async function revealBoardAnimated() {
    const cells = [];
    for (let r = 0; r < GAME.values.length; r++) {
      for (let c = 0; c < GAME.categories.length; c++) {
        cells.push({ c, r });
      }
    }
    for (let i = cells.length - 1; i > 0; i--) {
      const j = Math.floor(Math.random() * (i + 1));
      [cells[i], cells[j]] = [cells[j], cells[i]];
    }

    const boardFillAudio = document.getElementById("audioBoardFill");
    let durationSec = 0;
    if (boardFillAudio) {
      if (boardFillAudio.readyState >= 1 && Number.isFinite(boardFillAudio.duration) && boardFillAudio.duration > 0) {
        durationSec = boardFillAudio.duration;
      } else {
        durationSec = await new Promise((resolve) => {
          const onLoaded = () => resolve(boardFillAudio.duration && Number.isFinite(boardFillAudio.duration) ? boardFillAudio.duration : 0);
          boardFillAudio.addEventListener("loadedmetadata", onLoaded, { once: true });
          boardFillAudio.load();
          setTimeout(() => { boardFillAudio.removeEventListener("loadedmetadata", onLoaded); resolve(0); }, 3000);
        });
      }
    }
    const numTiles = cells.length;
    const delayMs = numTiles <= 1 ? 0 : (durationSec > 0 ? (durationSec * 1000) / (numTiles - 1) : 240);

    if (boardFillAudio) {
      boardFillAudio.currentTime = 0;
      boardFillAudio.volume = 0.7;
      boardFillAudio.play().catch(() => {});
    }

    for (const { c, r } of cells) {
      const cell = boardEl.querySelector(`.cell.question[data-c="${c}"][data-r="${r}"]`);
      if (cell && !cell.classList.contains("used")) {
        cell.classList.remove("cell-hidden");
        cell.textContent = "$" + GAME.values[r];
        const clue = GAME.categories[c].clues[r];
        if (state.showDD && clue.dd) {
          const badge = document.createElement("span");
          badge.className = "badge";
          badge.textContent = "DD";
          cell.appendChild(badge);
        }
        if (delayMs > 0) await new Promise(resolve => setTimeout(resolve, delayMs));
      }
    }

    state.questionTilesRevealed = true;
  }

  function renderScoreboard(){
    scoreboardEl.innerHTML = `
      <div class="teams">
        ${GAME.teams.map(t=>`
          <div class="team">
            <div class="name">
              <span>${esc(t)}</span>
              <span class="score" id="score-${cssId(t)}">${money(state.scores[t])}</span>
            </div>
            <div class="adj">
              <button class="good" data-adj="+100" data-team="${esc(t)}">+100</button>
              <button class="danger" data-adj="-100" data-team="${esc(t)}">-100</button>
              <button class="secondary" data-setactive="${esc(t)}">Active</button>
            </div>
          </div>
        `).join("")}
      </div>
      <div class="pill">Active team: <strong style="color:var(--text)">${esc(state.activeTeam)}</strong></div>
    `;

    scoreboardEl.querySelectorAll("button[data-adj]").forEach(b=>{
      b.onclick=()=>{ state.scores[b.dataset.team]+=parseInt(b.dataset.adj,10); updateScores(); };
    });
    scoreboardEl.querySelectorAll("button[data-setactive]").forEach(b=>{
      b.onclick=()=>{ state.activeTeam=b.dataset.setactive; renderScoreboard(); if(qOverlay.classList.contains("show")) renderQTeams(); };
    });
  }

  function renderBoard(){
    boardEl.style.gridTemplateColumns = `repeat(${GAME.categories.length}, minmax(140px,1fr))`;
    const cells=[];
    // Hide categories with blank tiles until buzz-in is done
    GAME.categories.forEach(cat=>cells.push(`<div class="cell category">${state.categoriesRevealed ? esc(cat.name) : ""}</div>`));
    for(let r=0;r<GAME.values.length;r++){
      for(let c=0;c<GAME.categories.length;c++){
        const used = state.used.has(keyOf(c,r));
        const clue = GAME.categories[c].clues[r];
        const show = state.showDD && clue.dd;
        const showValue = state.questionTilesRevealed;
        cells.push(`
          <div class="cell question ${used?"used":""} ${!showValue?"cell-hidden":""}" data-c="${c}" data-r="${r}" tabindex="0">
            ${used ? "" : (showValue ? "$"+GAME.values[r] : "")}
            ${show && showValue ? `<span class="badge">DD</span>` : ""}
          </div>
        `);
      }
    }
    boardEl.innerHTML = cells.join("");
    boardEl.querySelectorAll(".cell.question").forEach(cell=>{
      const open=()=>{
        const c=+cell.dataset.c, r=+cell.dataset.r;
        if(state.used.has(keyOf(c,r))) return;
        openQuestion(c,r);
      };
      cell.onclick=open;
      cell.onkeydown=(e)=>{ if(e.key==="Enter"||e.key===" "){e.preventDefault();open();}};
    });
  }

  function openQuestion(c,r){
    const cat=GAME.categories[c], clue=cat.clues[r], value=GAME.values[r];
    state.current={c,r,value,clue};
    // Question text: one sentence per line (split on . ? !), preserve existing newlines
    const questionText = String(clue.q || "").trim().replace(/([.?!])\s+/g, "$1\n");
    $("#qPrompt").textContent = questionText;
    $("#qAnswer").textContent=clue.a;
    $("#qReveal").classList.remove("show");
    // Meta pills below question: category, value, DD, active team (same pill style as before)
    const catEl = document.getElementById("qCategoryPill");
    const valEl = document.getElementById("qValuePill");
    const ddEl = document.getElementById("qDDPill");
    const teamEl = document.getElementById("qActiveTeamPill");
    if (catEl) catEl.textContent = cat.name;
    if (valEl) valEl.textContent = money(value);
    if (ddEl) ddEl.style.display = clue.dd ? "inline-flex" : "none";
    if (teamEl) teamEl.textContent = state.activeTeam;

    // Clue images: up to 2 (clue.images array or single clue.image)
    const imgList = clue.images && clue.images.length ? clue.images : (clue.image ? [clue.image] : []);
    const img1 = document.getElementById("qClueImage1");
    const img2 = document.getElementById("qClueImage2");
    if (img1) { if (imgList[0]) img1.src = imgList[0]; else img1.removeAttribute("src"); }
    if (img2) { if (imgList[1]) img2.src = imgList[1]; else img2.removeAttribute("src"); }

    // Clue audio: play if clue has audio (assets in /assets/audio or /assets)
    if (clue.audio) {
      const clueAudio = new Audio(clue.audio);
      clueAudio.play().catch(err => console.warn("Clue audio failed:", err));
    }

    qOverlay.classList.add("show");

    // Play sound effects (DD or question song; clue.audio is separate)
    if(clue.dd) {
      playSound('dailyDouble');
    } else {
      playSound('questionSong');
    }
  }

  function renderQTeams(){
    const teamPill = document.getElementById("qActiveTeamPill");
    if (teamPill && qOverlay.classList.contains("show")) teamPill.textContent = state.activeTeam;
  }

  function closeQ(){ 
    qOverlay.classList.remove("show"); 
    state.current=null;
    // Stop question song when closing
    stopSound('questionSong');
  }
  function markUsed(c,r){
    state.used.add(keyOf(c,r));
    const tile = boardEl.querySelector(`.cell.question[data-c="${c}"][data-r="${r}"]`);
    if(tile){ tile.classList.add("used"); tile.innerHTML=""; }
  }
  function updateScores(){
    GAME.teams.forEach(t=>{
      const el=document.getElementById(`score-${cssId(t)}`);
      if(el) el.textContent=money(state.scores[t]);
    });
  }

  function applyResult(correct){
    if(!state.current) return;
    const {c,r,value,clue}=state.current;
    let delta=value;
    if(clue.dd){
      const w = Number(prompt(`Daily Double! Enter wager for ${state.activeTeam}:`, String(value)));
      if(Number.isFinite(w) && w>=0) delta=Math.round(w);
    }
    state.scores[state.activeTeam] += correct ? delta : -delta;
    updateScores();
    markUsed(c,r);

    // Play sound effect
    playSound(correct ? 'correct' : 'incorrect');

    closeQ();

    // When active team gets it wrong: normal = buzz-in for next team; testing = cycle to next team
    if (!correct && GAME.teams && GAME.teams.length > 0) {
      if (state.testingMode) {
        const idx = GAME.teams.indexOf(state.activeTeam);
        const nextIdx = (idx + 1) % GAME.teams.length;
        state.activeTeam = GAME.teams[nextIdx];
        renderScoreboard();
      } else if (roomCode) {
        buzzInPhaseActive = true;
        onFirstBuzzCallback = (winnerName) => {
          state.activeTeam = winnerName;
          const overlay = document.getElementById("buzzInOverlay");
          if (overlay) overlay.classList.remove("show");
          updateDoc(doc(db,"rooms",roomCode), { locked:false, winnerName:null, winnerUid:null }).catch(()=>{});
          setBuzzerUI({ locked: false, winnerName: null });
          renderScoreboard();
        };
        updateDoc(doc(db,"rooms",roomCode), { locked:false, winnerName:null, winnerUid:null }).catch(()=>{});
        const buzzOverlay = document.getElementById("buzzInOverlay");
        if (buzzOverlay) buzzOverlay.classList.add("show");
      }
    }

    // If current round is fully played and Round 2 has categories, show Round 2 overlay
    const totalCells = GAME.categories.length * GAME.values.length;
    const hasRound2 = GAME.rounds && GAME.rounds.length > 1 && GAME.rounds[1].categories && GAME.rounds[1].categories.length > 0;
    if (state.used.size >= totalCells && state.currentRound === 0 && hasRound2) {
      const overlay = document.getElementById("round2Overlay");
      if (overlay) overlay.classList.add("show");
    }
  }

  function advanceToRound2() {
    state.currentRound = 1;
    state.used = new Set();
    if (GAME.rounds && GAME.rounds[1]) {
      GAME.categories = GAME.rounds[1].categories;
      GAME.values = GAME.rounds[1].values;
    }
    state.questionTilesRevealed = true;
    const overlay = document.getElementById("round2Overlay");
    if (overlay) overlay.classList.remove("show");
    renderBoard();
  }

  function openFinal(){
    $("#fMeta").textContent = GAME.final.category;
    $("#fPrompt").textContent = GAME.final.q;
    $("#fAnswer").textContent = GAME.final.a;
    $("#fReveal").classList.remove("show");
    
    // Play Final Jeopardy sound
    playSound('finalJeopardy');

    const grid=$("#finalGrid");
    grid.innerHTML = GAME.teams.map(t=>`
      <div class="final-card" data-team="${esc(t)}">
        <div style="display:flex;justify-content:space-between;align-items:center;gap:8px">
          <div class="tname">${esc(t)}</div>
          <div class="tscore">${money(state.scores[t])}</div>
        </div>
        <label>Wager</label>
        <input type="number" min="0" step="1" inputmode="numeric" placeholder="e.g., 500" value="${state.final.wagers[t] ?? ""}">
        <div style="display:flex;gap:10px;margin-top:10px;flex-wrap:wrap">
          <button class="good" data-correct="1">Correct</button>
          <button class="danger" data-correct="0">Wrong</button>
          <span class="pill" style="margin-left:auto" id="finalMark-${cssId(t)}">${
            state.final.correct[t]===true ? "Marked: Correct" :
            state.final.correct[t]===false ? "Marked: Wrong" : "Not marked"
          }</span>
        </div>
      </div>
    `).join("");

    grid.querySelectorAll(".final-card").forEach(card=>{
      const team=card.dataset.team;
      const input=card.querySelector("input");
      input.oninput=()=>{ const v=Number(input.value); state.final.wagers[team]=Number.isFinite(v)?Math.max(0,Math.round(v)):0; };
      card.querySelectorAll("button[data-correct]").forEach(btn=>{
        btn.onclick=()=>{
          state.final.correct[team]=btn.dataset.correct==="1";
          const mark=document.getElementById(`finalMark-${cssId(team)}`);
          if(mark) mark.textContent = state.final.correct[team] ? "Marked: Correct" : "Marked: Wrong";
        };
      });
    });

    fOverlay.classList.add("show");
  }

  function applyFinal(){
    GAME.teams.forEach(t=>{
      const w=Number(state.final.wagers[t] ?? 0);
      const ok=state.final.correct[t];
      if(ok===true) state.scores[t]+=w;
      else if(ok===false) state.scores[t]-=w;
    });
    updateScores();
    renderScoreboard();
    alert("Final wagers applied.");
  }

  /* =========================
     SOUND EFFECTS
     ========================= */
  const audioElements = {
    theme: document.getElementById('audioTheme'),
    correct: document.getElementById('audioCorrect'),
    incorrect: document.getElementById('audioIncorrect'),
    dailyDouble: document.getElementById('audioDailyDouble'),
    finalJeopardy: document.getElementById('audioFinalJeopardy'),
    questionSong: document.getElementById('audioQuestionSong'),
    timesUp: document.getElementById('audioTimesUp')
  };

  function playSound(soundName) {
    const audio = audioElements[soundName];
    if (audio) {
      audio.pause();        // Stop if already playing so replay works (e.g. wrong twice in a row)
      audio.currentTime = 0;
      audio.play().catch(err => console.warn(`Could not play ${soundName}:`, err));
    }
  }

  function stopSound(soundName) {
    const audio = audioElements[soundName];
    if (audio) {
      audio.pause();
      audio.currentTime = 0;
    }
  }

  function bindUI(){
    $("#btnToggleDD").onclick=()=>{ state.showDD=!state.showDD; $("#btnToggleDD").textContent=state.showDD?"Host: Hide DD":"Host: Show DD"; renderBoard(); };
    $("#btnReset").onclick=()=>{
      if(!confirm("Reset board & scores?"))return;
      state.used=new Set();
      state.currentRound=0;
      GAME.teams.forEach(t=>state.scores[t]=0);
      state.final={wagers:{},correct:{}};
      if (GAME.rounds && GAME.rounds[0]) {
        GAME.categories = GAME.rounds[0].categories;
        GAME.values = GAME.rounds[0].values;
      }
      renderScoreboard();
      renderBoard();
    };
    $("#btnFinal").onclick=openFinal;

    qOverlay.onclick=(e)=>{ if(e.target===qOverlay) closeQ(); };
    $("#btnReveal").onclick=()=>$("#qReveal").classList.toggle("show");
    $("#btnCorrect").onclick=()=>applyResult(true);
    $("#btnWrong").onclick=()=>applyResult(false);

    $("#btnCloseF").onclick=()=>fOverlay.classList.remove("show");
    fOverlay.onclick=(e)=>{ if(e.target===fOverlay) fOverlay.classList.remove("show"); };
    $("#btnRevealFinal").onclick=()=>$("#fReveal").classList.toggle("show");
    $("#btnApplyFinal").onclick=applyFinal;

    $("#btnViewCategories").onclick=openViewCategories;
    document.getElementById("btnCategoryNext").onclick=nextViewCategory;
    const btnRound2Continue = document.getElementById("btnRound2Continue");
    if (btnRound2Continue) btnRound2Continue.onclick = advanceToRound2;

    // Start button handler
    const startButton = document.getElementById('startButton');
    const splashScreen = document.getElementById('splashScreen');
    if (startButton && splashScreen) {
      startButton.onclick = async () => {
        state.testingMode = false;
        gameStarted = true;
        await loadGameData();
        splashScreen.classList.add('hidden');
        document.body.classList.add('game-started');
        await createRoom();
        setTimeout(() => { showQRCode(); }, 300);
      };
    }

    // Testing Environment: bypass QR + buzz-in, 4 teams, random active, go to board reveal
    const testingEnvButton = document.getElementById('testingEnvButton');
    if (testingEnvButton && splashScreen) {
      testingEnvButton.onclick = async () => {
        state.testingMode = true;
        stopSound('theme');
        gameStarted = true;
        await loadGameData();
        splashScreen.classList.add('hidden');
        document.body.classList.add('game-started');
        await createRoom();
        // Do NOT show QR code or buzz-in
        GAME.teams = ['Team 1', 'Team 2', 'Team 3', 'Team 4'];
        initJeopardy();
        state.activeTeam = GAME.teams[Math.floor(Math.random() * 4)];
        if (typeof onFirstBuzzCallback === 'function') {
          onFirstBuzzCallback(state.activeTeam);
        }
      };
    }
  }

  // START - Initialize UI and start theme music IMMEDIATELY
  // CRITICAL: Don't initialize game until start button is clicked
  // setupTeams() MUST ONLY be called from the start button handler above
  
  bindUI();
  
  // Start theme music IMMEDIATELY when splash screen appears
  // Try to play right away - no delays
  (function startThemeMusicImmediately() {
    const themeAudio = document.getElementById('audioTheme');
    if (themeAudio) {
      themeAudio.volume = 0.7;
      // Try to play immediately
      themeAudio.play().catch(err => {
        // If autoplay is blocked, try again when user interacts
        console.log('Autoplay blocked, will play on first interaction');
        const playOnInteraction = () => {
          themeAudio.play().catch(() => {});
        };
        // Try on any user interaction
        document.addEventListener('click', playOnInteraction, { once: true });
        document.addEventListener('touchstart', playOnInteraction, { once: true });
        document.addEventListener('keydown', playOnInteraction, { once: true });
      });
    } else {
      // Audio element not ready yet, try again in a moment
      setTimeout(startThemeMusicImmediately, 50);
    }
  })();
  
  // Also ensure it plays when DOM is fully ready
  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', () => {
      const themeAudio = document.getElementById('audioTheme');
      if (themeAudio && themeAudio.paused) {
        themeAudio.volume = 0.7;
        themeAudio.play().catch(() => {});
      }
    });
  }
</script>
</body>
</html>
