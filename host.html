<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Jeopardy + Firebase Buzzer</title>
  <script src="https://cdn.jsdelivr.net/npm/qrcodejs@1.0.0/qrcode.min.js"></script>
  <style>
    :root{--bg:#0b1020;--panel:#111a33;--tile:#17306e;--tile2:#10265c;--accent:#f7c948;--text:#e9eefc;--muted:#a9b5d6;--danger:#ff5d5d;--good:#46d39a;--border:rgba(255,255,255,.12);--shadow:0 10px 30px rgba(0,0,0,.35);--radius:16px;--font:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif;}
    *{box-sizing:border-box}
    body{margin:0;font-family:var(--font);background:radial-gradient(1200px 800px at 20% 10%, #1a2a66 0%, var(--bg) 50%, #070a14 100%);color:var(--text);min-height:100vh;padding:18px;}
    header{display:flex;align-items:center;justify-content:space-between;gap:12px;margin:0 auto 14px;max-width:1200px;}
    h1{font-size:20px;margin:0;letter-spacing:.5px}
    .sub{color:var(--muted);font-size:13px}
    .controls{display:flex;gap:10px;flex-wrap:wrap;justify-content:flex-end}
    button{background:linear-gradient(180deg,#1c2f72,#13265e);color:var(--text);border:1px solid var(--border);border-radius:999px;padding:10px 14px;cursor:pointer;box-shadow:var(--shadow);font-weight:600;}
    button:hover{filter:brightness(1.06)} button:active{transform:translateY(1px)}
    button.secondary{background:transparent;box-shadow:none}
    button.danger{background:linear-gradient(180deg,#7a1b1b,#4a0f0f)}
    button.good{background:linear-gradient(180deg,#146b4b,#0b3d2a)}
    main{max-width:1200px;margin:0 auto;display:grid;grid-template-columns:1fr;gap:14px;}
    .row2{display:grid;grid-template-columns:1.2fr .8fr;gap:14px}
    @media (max-width:980px){.row2{grid-template-columns:1fr}}
    .panel{background:rgba(17,26,51,.78);border:1px solid var(--border);border-radius:var(--radius);padding:12px;box-shadow:var(--shadow);}
    .scoreboard{display:flex;align-items:center;justify-content:space-between;gap:12px;flex-wrap:wrap;}
    .teams{display:flex;gap:10px;flex-wrap:wrap}
    .team{background:rgba(255,255,255,.05);border:1px solid var(--border);border-radius:14px;padding:10px 12px;min-width:180px;}
    .team .name{display:flex;align-items:center;justify-content:space-between;gap:8px;font-weight:800}
    .team .score{font-size:20px;color:var(--accent)}
    .team .adj{display:flex;gap:8px;margin-top:10px;flex-wrap:wrap}
    .board{display:grid;gap:10px;background:rgba(17,26,51,.55);border:1px solid var(--border);border-radius:var(--radius);padding:12px;box-shadow:var(--shadow);overflow:auto;}
    .cell{border-radius:14px;border:1px solid var(--border);background:linear-gradient(180deg,var(--tile),var(--tile2));padding:10px;min-height:72px;display:flex;align-items:center;justify-content:center;text-align:center;user-select:none;position:relative;}
    .cell.category{background:linear-gradient(180deg,#2a3f8f,#1b2f74);font-weight:900;letter-spacing:.4px;text-transform:uppercase;font-size:13px;}
    .cell.question{cursor:pointer;font-weight:900;font-size:20px;color:var(--accent);}
    .cell.question.used{cursor:not-allowed;filter:grayscale(.9) brightness(.75);color:rgba(247,201,72,.35);}
    .badge{position:absolute;top:8px;right:8px;font-size:11px;color:#0b1020;background:var(--accent);padding:3px 8px;border-radius:999px;font-weight:900;}
    .pill{display:inline-flex;padding:8px 12px;border-radius:999px;border:1px solid var(--border);background:rgba(255,255,255,.05);font-weight:700;color:var(--muted);gap:8px;align-items:center;}
    .small{font-size:12px;color:var(--muted)}
    .mono{font-family:ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,monospace}
    .overlay{position:fixed;inset:0;background:rgba(0,0,0,.70);display:none;align-items:center;justify-content:center;padding:18px;z-index:50;}
    .overlay.show{display:flex}
    .modal{width:min(820px,100%);background:rgba(17,26,51,.94);border:1px solid var(--border);border-radius:22px;box-shadow:var(--shadow);padding:16px;}
    .modal header{max-width:none;margin:0;padding:0 0 10px 0;display:flex;align-items:center;justify-content:space-between;gap:12px}
    .modal h2{margin:0;font-size:16px}
    .meta{color:var(--muted);font-size:13px}
    .prompt{margin:14px 0;font-size:28px;font-weight:900;line-height:1.15;text-align:center;padding:18px;border-radius:18px;border:1px solid var(--border);background:rgba(0,0,0,.18);}
    .reveal{margin:12px auto 0;max-width:740px;display:none;border-top:1px solid var(--border);padding-top:12px;}
    .reveal.show{display:block}
    .reveal .label{color:var(--muted);font-size:12px;text-transform:uppercase;letter-spacing:.4px}
    .reveal .answer{font-size:20px;font-weight:800;margin-top:6px}
    .actions{display:flex;gap:10px;flex-wrap:wrap;justify-content:space-between;margin-top:14px;}
    .actions .left,.actions .right{display:flex;gap:10px;flex-wrap:wrap}
    .final-grid{display:grid;gap:10px;grid-template-columns:repeat(auto-fit,minmax(220px,1fr));}
    .final-card{background:rgba(255,255,255,.05);border:1px solid var(--border);border-radius:18px;padding:12px;}
    .final-card .tname{font-weight:900}
    .final-card .tscore{color:var(--accent);font-weight:900}
    .final-card label{display:block;color:var(--muted);font-size:12px;margin-top:10px}
    .final-card input{width:100%;background:rgba(0,0,0,.18);color:var(--text);border:1px solid var(--border);border-radius:12px;padding:10px 10px;margin-top:6px;}

    /* Fullscreen QR modal */
    #qrModal {
      width: 96vw;
      height: 92vh;
      max-width: none;
      display:flex;
      flex-direction:column;
      align-items:center;
      justify-content:center;
      text-align:center;
    }
    #qrCanvas {
      width: min(82vmin, 980px);
      height: min(82vmin, 980px);
      background:#fff;
      padding:18px;
      border-radius:22px;
      border:1px solid rgba(0,0,0,.25);
    }

    /* Splash Screen */
    #splashScreen {
      position: fixed;
      inset: 0;
      background: url('Cermak Jeopardy splash.png') center/cover no-repeat;
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 100;
      transition: opacity 0.5s ease-out;
    }
    #splashScreen.hidden {
      opacity: 0;
      pointer-events: none;
    }
    #startButton {
      position: absolute;
      bottom: 2%;
      left: 50%;
      transform: translateX(-50%);
      background: linear-gradient(180deg, #f7c948, #d4a83a);
      color: #0b1020;
      border: 3px solid #fff;
      border-radius: 999px;
      padding: 20px 60px;
      font-size: 32px;
      font-weight: 900;
      cursor: pointer;
      box-shadow: 0 10px 30px rgba(0,0,0,.5), 0 0 20px rgba(247,201,72,.5);
      text-transform: uppercase;
      letter-spacing: 2px;
      transition: all 0.2s;
    }
    #startButton:hover {
      transform: translateX(-50%) scale(1.05);
      box-shadow: 0 15px 40px rgba(0,0,0,.6), 0 0 30px rgba(247,201,72,.7);
    }
    #startButton:active {
      transform: translateX(-50%) scale(0.98);
    }

    /* Hide main content until game starts */
    body.game-started header,
    body.game-started main {
      display: block;
    }
    body:not(.game-started) header,
    body:not(.game-started) main {
      display: none;
    }
  </style>
</head>
<body>
<!-- Splash Screen -->
<div id="splashScreen">
  <button id="startButton">Start</button>
</div>

<!-- Audio Elements -->
<audio id="audioTheme" loop>
  <source src="Resources/jeopardy_theme.mp3" type="audio/mpeg">
</audio>
<audio id="audioCorrect">
  <source src="Resources/correct.mp3" type="audio/mpeg">
</audio>
<audio id="audioIncorrect">
  <source src="Resources/incorrect.mp3" type="audio/mpeg">
</audio>
<audio id="audioDailyDouble">
  <source src="Resources/daily_double.mp3" type="audio/mpeg">
</audio>
<audio id="audioFinalJeopardy">
  <source src="Resources/final_jeopardy.mp3" type="audio/mpeg">
</audio>
<audio id="audioQuestionSong">
  <source src="Resources/question_song.mp3" type="audio/mpeg">
</audio>
<audio id="audioTimesUp">
  <source src="Resources/times_up.mp3" type="audio/mpeg">
</audio>
<header>
  <div>
    <h1 id="gameTitle">Jeopardy</h1>
    <div class="sub" id="gameSubtitle">Phones buzz in → host awards points.</div>
  </div>
  <div class="controls">
    <button class="secondary" id="btnToggleDD">Host: Show DD</button>
    <button id="btnFinal">Final Jeopardy</button>
    <button class="danger" id="btnReset">Reset Game</button>
  </div>
</header>

<main>
  <div class="row2">
    <section class="panel scoreboard" id="scoreboard"></section>

    <section class="panel">
      <div style="display:flex;align-items:center;justify-content:space-between;gap:10px;flex-wrap:wrap">
        <div>
          <div style="font-weight:900">Firebase Buzzer</div>
          <div class="small">Send players the join link + room code.</div>
        </div>
        <div style="display:flex;gap:10px;flex-wrap:wrap;align-items:center">
          <span class="pill">Room: <span class="mono" id="roomCode">—</span></span>
          <button id="btnNewRoom">New Room</button>
          <button class="secondary" id="btnShowQR">Show QR</button>
          <button class="danger" id="btnResetBuzz" disabled>Reset Buzz</button>
        </div>
      </div>

      <div style="margin-top:12px">
        <div class="small">Join link:</div>
        <div class="mono" id="joinLink">—</div>
      </div>

      <div style="margin-top:12px;display:flex;gap:10px;flex-wrap:wrap;align-items:center">
        <span class="pill">Status: <span id="buzzStatus">—</span></span>
        <span class="pill">Winner: <span id="buzzWinner">—</span></span>
      </div>

      <div style="margin-top:12px">
        <div class="small">Players:</div>
        <div id="playerList">—</div>
      </div>
    </section>
  </div>

  <section class="board" id="board"></section>
</main>

<!-- Question Modal -->
<div class="overlay" id="qOverlay">
  <div class="modal">
    <header>
      <div>
        <h2 id="qTitle"></h2>
        <div class="meta" id="qMeta"></div>
      </div>
      <button class="secondary" id="btnCloseQ">Close</button>
    </header>

    <div class="prompt" id="qPrompt"></div>

    <div class="reveal" id="qReveal">
      <div class="label">Answer</div>
      <div class="answer" id="qAnswer"></div>
    </div>

    <div class="actions">
      <div class="left">
        <span class="pill" id="qValuePill"></span>
        <span class="pill" id="qDDPill" style="display:none">Daily Double</span>
      </div>
      <div class="right">
        <button id="btnReveal">Reveal Answer</button>
        <button class="good" id="btnCorrect">Correct (+)</button>
        <button class="danger" id="btnWrong">Wrong (-)</button>
      </div>
    </div>

    <div class="small" style="margin-top:10px">Select which team is answering:</div>
    <div class="teams" id="qTeams" style="margin-top:10px"></div>
  </div>
</div>

<!-- Final Jeopardy Modal -->
<div class="overlay" id="fOverlay">
  <div class="modal">
    <header>
      <div>
        <h2>Final Jeopardy</h2>
        <div class="meta" id="fMeta"></div>
      </div>
      <button class="secondary" id="btnCloseF">Close</button>
    </header>

    <div class="prompt" id="fPrompt"></div>

    <div class="final-grid" id="finalGrid"></div>

    <div class="reveal" id="fReveal">
      <div class="label">Answer</div>
      <div class="answer" id="fAnswer"></div>
    </div>

    <div class="actions">
      <div class="left"></div>
      <div class="right">
        <button id="btnRevealFinal">Reveal Answer</button>
        <button class="good" id="btnApplyFinal">Apply Wagers</button>
      </div>
    </div>

    <div class="small">Enter wagers, mark Correct/Wrong, then “Apply Wagers”.</div>
  </div>
</div>

<!-- QR Modal (Fullscreen) -->
<div class="overlay" id="qrOverlay" aria-modal="true" role="dialog">
  <div class="modal" id="qrModal">
    <header style="width:100%;max-width:1200px">
      <div>
        <h2 style="font-size:20px;margin:0">Join Buzzer</h2>
        <div class="meta" style="margin-top:4px">
          Scan this QR code → opens player page<br>
          Room code: <span class="mono" id="qrRoomText">—</span>
        </div>
      </div>
      <button class="secondary" id="btnCloseQR">Close</button>
    </header>

    <canvas id="qrCanvas"></canvas>

    <div class="small mono" id="qrUrlText" style="word-break:break-all;margin-top:14px;max-width:1200px">
      —
    </div>
  </div>
</div>

<script type="module">
  // IMPORTANT: Game initialization is deferred until Start button is clicked
  // This prevents setupTeams() from running on page load
  
  // Wait for QRCode library to be available
  function waitForQRCode() {
    return new Promise((resolve) => {
      if (typeof QRCode !== 'undefined') {
        console.log("QRCode library already loaded");
        resolve();
        return;
      }
      let attempts = 0;
      const checkInterval = setInterval(() => {
        attempts++;
        if (typeof QRCode !== 'undefined') {
          clearInterval(checkInterval);
          console.log("QRCode library loaded after", attempts * 100, "ms");
          resolve();
        } else if (attempts > 50) { // 5 seconds max wait
          clearInterval(checkInterval);
          console.warn("QRCode library did not load in time");
          resolve(); // Continue anyway
        }
      }, 100);
    });
  }

  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-app.js";
  import { getAuth, signInAnonymously } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-auth.js";
  import {
    getFirestore, doc, setDoc, updateDoc, onSnapshot,
    serverTimestamp, collection, query, onSnapshot as onSnapQuery
  } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-firestore.js";

  // Wait for QRCode to load
  await waitForQRCode();
  
  // Initialize Firebase (but don't create room yet)
  const firebaseConfig = {
    apiKey: "AIzaSyAadTD1tOCnYrqOP43dpeQpPBzlqv-JdvE",
    authDomain: "jeopardy-5956d.firebaseapp.com",
    projectId: "jeopardy-5956d",
    storageBucket: "jeopardy-5956d.firebasestorage.app",
    messagingSenderId: "979136812527",
    appId: "1:979136812527:web:904c0fc6f773f20596921a"
  };

  const app = initializeApp(firebaseConfig);
  const auth = getAuth(app);
  const db = getFirestore(app);
  await signInAnonymously(auth);

  /* ===== QR GENERATOR using qrcodejs library ===== */
let qrCodeInstance = null;

function makeQR(canvas, text) {
  try {
    // Check if QRCode library is available
    if (typeof QRCode === 'undefined') {
      console.error("QRCode library not loaded");
      return;
    }

    // Ensure text is a string
    const urlString = String(text).trim();
    if (!urlString) {
      console.error("QR code: empty text");
      return;
    }

    if (!canvas) {
      console.error("QR code: canvas element not found");
      return;
    }

    // Get the actual displayed size from CSS
    const rect = canvas.getBoundingClientRect();
    const displaySize = Math.max(200, Math.min(rect.width || 400, rect.height || 400));
    
    console.log("Generating QR code:", { url: urlString, displaySize, canvasRect: rect });
    
    // Clear canvas first
    const ctx = canvas.getContext("2d");
    canvas.width = displaySize;
    canvas.height = displaySize;
    ctx.fillStyle = "#ffffff";
    ctx.fillRect(0, 0, displaySize, displaySize);
    
    // qrcodejs library creates its own canvas, so we need to use a temporary container
    // Create or reuse a temporary container
    let tempContainer = document.getElementById('qr-temp-container');
    if (!tempContainer) {
      tempContainer = document.createElement('div');
      tempContainer.id = 'qr-temp-container';
      tempContainer.style.position = 'absolute';
      tempContainer.style.left = '-9999px';
      tempContainer.style.width = displaySize + 'px';
      tempContainer.style.height = displaySize + 'px';
      document.body.appendChild(tempContainer);
    } else {
      // Clear previous QR code
      tempContainer.innerHTML = '';
      tempContainer.style.width = displaySize + 'px';
      tempContainer.style.height = displaySize + 'px';
    }

    // Use qrcodejs library - it creates its own canvas element
    qrCodeInstance = new QRCode(tempContainer, {
      text: urlString,
      width: displaySize,
      height: displaySize,
      colorDark: "#000000",
      colorLight: "#ffffff",
      correctLevel: QRCode.CorrectLevel.M
    });

    // Wait for QR code to render, then copy to our canvas
    setTimeout(() => {
      const qrCanvas = tempContainer.querySelector('canvas');
      if (qrCanvas && canvas) {
        // Copy the QR code from the library's canvas to our canvas
        ctx.clearRect(0, 0, displaySize, displaySize);
        ctx.fillStyle = "#ffffff";
        ctx.fillRect(0, 0, displaySize, displaySize);
        ctx.drawImage(qrCanvas, 0, 0, displaySize, displaySize);
        console.log("QR code generated successfully:", { 
          url: urlString, 
          size: displaySize,
          canvasWidth: canvas.width,
          canvasHeight: canvas.height
        });
      }
    }, 100);
    
  } catch (error) {
    console.error("QR code generation exception:", error);
  }
}


  /* =========================
     GAME CONTENT
     ========================= */
  const GAME = {
    title: "CERMAK Jeopardy",
    subtitle: "Phones buzz in → host awards points.",
    teams: [],
    values: [100,200,300,400,500],
    categories: [
      { name:"Medicine", clues:[
        { q:"This vital sign is measured in mmHg.", a:"What is blood pressure?" },
        { q:"First-line med classes often used for essential HTN.", a:"What are thiazides / ACEi/ARB / CCB (any acceptable)?" },
        { q:"ECG finding classically associated with hyperkalemia.", a:"What are peaked T waves?" },
        { q:"Score estimating stroke risk in atrial fibrillation.", a:"What is CHA₂DS₂-VASc?" },
        { q:"Daily Double: Antibiotic class of vancomycin.", a:"What is a glycopeptide?", dd:true },
      ]},
      { name:"Movies", clues:[
        { q:"He directed 'Jaws' and 'E.T.'", a:"Who is Steven Spielberg?" },
        { q:"1999 film with the 'first rule' of an underground club.", a:"What is Fight Club?" },
        { q:"Fictional African nation in Black Panther.", a:"What is Wakanda?" },
        { q:"Actor who played Joker in The Dark Knight.", a:"Who is Heath Ledger?" },
        { q:"Daily Double: 'I’ll be back' character.", a:"Who is the Terminator (T-800)?", dd:true },
      ]},
      { name:"Science", clues:[
        { q:"Force equals mass times…", a:"What is acceleration?" },
        { q:"Plants turning light into chemical energy.", a:"What is photosynthesis?" },
        { q:"Most abundant gas in Earth’s atmosphere.", a:"What is nitrogen?" },
        { q:"Negatively charged particle.", a:"What is an electron?" },
        { q:"Daily Double: SI unit of current.", a:"What is the ampere?", dd:true },
      ]},
      { name:"Food & Drink", clues:[
        { q:"Tequila + lime + triple sec cocktail.", a:"What is a Margarita?" },
        { q:"Garlic + tomatoes + basil sauce.", a:"What is marinara?" },
        { q:"Agave spirit; smoky versions often from Oaxaca.", a:"What is mezcal?" },
        { q:"Low-temp vacuum bag cooking method.", a:"What is sous vide?" },
        { q:"Daily Double: Polish dumplings.", a:"What are pierogi?", dd:true },
      ]},
      { name:"Poland", clues:[
        { q:"Capital of Poland.", a:"What is Warsaw (Warszawa)?" },
        { q:"Region known for Góralski culture.", a:"What is Podhale / Tatra region?" },
        { q:"Famous salt mine near Kraków.", a:"What is Wieliczka?" },
        { q:"Poland’s currency.", a:"What is the złoty (PLN)?" },
        { q:"Daily Double: Sea bordering northern Poland.", a:"What is the Baltic Sea?", dd:true },
      ]},
    ],
    final: { category:"Final Jeopardy", q:"This US city is known as the 'Windy City'.", a:"What is Chicago?" }
  };

  let gameStarted = false; // Flag to prevent premature initialization
  
  function setupTeams(){
    // This function should ONLY be called when Start button is clicked
    if (!gameStarted) {
      console.warn('setupTeams called before game start - this should not happen!');
      return;
    }
    
    let count;
    do { count = parseInt(prompt("How many teams?", "4") || "", 10); }
    while(!Number.isInteger(count) || count < 1);

    const teams=[];
    for(let i=1;i<=count;i++){
      let name="";
      while(!name) name = (prompt(`Enter name for Team ${i}:`, `Team ${i}`) || "").trim();
      teams.push(name.slice(0,24));
    }
    GAME.teams = teams;
  }

  /* =========================
     BUZZER (Firestore)
     ========================= */
  const roomCodeEl = document.getElementById("roomCode");
  const joinLinkEl = document.getElementById("joinLink");
  const buzzStatusEl = document.getElementById("buzzStatus");
  const buzzWinnerEl = document.getElementById("buzzWinner");
  const playerListEl = document.getElementById("playerList");
  const btnNewRoom = document.getElementById("btnNewRoom");
  const btnResetBuzz = document.getElementById("btnResetBuzz");

  // QR UI
  const btnShowQR = document.getElementById("btnShowQR");
  const qrOverlay = document.getElementById("qrOverlay");
  const btnCloseQR = document.getElementById("btnCloseQR");
  const qrCanvas = document.getElementById("qrCanvas");
  const qrUrlText = document.getElementById("qrUrlText");
  const qrRoomText = document.getElementById("qrRoomText");

  let roomCode = null;
  let unsubRoom = null;
  let unsubPlayers = null;

  function randCode(){ return String(Math.floor(1000 + Math.random()*9000)); }

  function playerUrlWithRoom(code){
    // Ensure we create an absolute URL
    const baseUrl = window.location.origin + window.location.pathname.replace(/\/[^\/]*$/, '/');
    const u = new URL("player.html", baseUrl);
    u.searchParams.set("room", code);
    const fullUrl = u.toString();
    console.log("Generated player URL:", fullUrl);
    return fullUrl;
  }

  function setBuzzerUI({locked, winnerName, players}){
    if (locked !== undefined) buzzStatusEl.textContent = roomCode ? (locked ? "LOCKED" : "Ready") : "—";
    if (winnerName !== undefined) buzzWinnerEl.textContent = winnerName || "—";
    if (players !== undefined) playerListEl.textContent = players.length ? players.join(", ") : "—";
  }

  async function createRoom(){
    roomCode = randCode();
    roomCodeEl.textContent = roomCode;
    joinLinkEl.textContent = `${playerUrlWithRoom(roomCode)} (Room: ${roomCode})`;
    btnResetBuzz.disabled = false;

    const ref = doc(db, "rooms", roomCode);
    await setDoc(ref, { createdAt: serverTimestamp(), locked:false, winnerName:null, winnerUid:null });

    watchRoom(roomCode);
    setBuzzerUI({locked:false, winnerName:null, players:[]});
  }

  function watchRoom(code){
    unsubRoom?.(); unsubPlayers?.();

    unsubRoom = onSnapshot(doc(db,"rooms",code), (snap)=>{
      if(!snap.exists()) return;
      const d = snap.data();
      setBuzzerUI({ locked: !!d.locked, winnerName: d.winnerName ?? null });
    });

    unsubPlayers = onSnapQuery(query(collection(db,"rooms",code,"players")), (qs)=>{
      const names=[];
      qs.forEach(s=>names.push(s.data()?.name || "?"));
      setBuzzerUI({ players: names });
    });
  }

  btnNewRoom.onclick = createRoom;

  btnResetBuzz.onclick = async ()=>{
    if(!roomCode) return;
    await updateDoc(doc(db,"rooms",roomCode), { locked:false, winnerName:null, winnerUid:null });
  };

  // Fullscreen QR
btnShowQR.onclick = () => {
  if (!roomCode) return alert("Create a room first.");

  // Check if QRCode library is loaded
  if (typeof QRCode === 'undefined') {
    console.error("QRCode library not found. Available globals:", Object.keys(window).filter(k => k.toLowerCase().includes('qr')));
    alert("QR Code library not loaded. Please refresh the page.\n\nIf the problem persists, check your internet connection.");
    return;
  }

  const url = playerUrlWithRoom(roomCode);
  qrUrlText.textContent = url;
  qrRoomText.textContent = roomCode;

  qrOverlay.classList.add("show");

  // Wait for layout to settle, then draw QR code
  // Use multiple delays to ensure everything is ready
  setTimeout(() => {
    requestAnimationFrame(() => {
      requestAnimationFrame(() => {
        makeQR(qrCanvas, url);
      });
    });
  }, 150);
};

  btnCloseQR.onclick = ()=> qrOverlay.classList.remove("show");
  qrOverlay.onclick = (e)=>{ if(e.target===qrOverlay) qrOverlay.classList.remove("show"); };
  window.addEventListener("keydown",(e)=>{ if(e.key==="Escape") qrOverlay.classList.remove("show"); });

  /* =========================
     JEOPARDY ENGINE
     ========================= */
  const $ = (s)=>document.querySelector(s);
  const boardEl = $("#board");
  const scoreboardEl = $("#scoreboard");
  const qOverlay = $("#qOverlay");
  const fOverlay = $("#fOverlay");

  const state = { used:new Set(), scores:{}, activeTeam:null, showDD:false, current:null, final:{ wagers:{}, correct:{} } };
  const keyOf=(c,r)=>`${c}-${r}`;
  const cssId=(s)=>s.replace(/[^a-z0-9_-]/gi,"_");
  const esc=(str)=>String(str).replace(/[&<>"']/g,m=>({ "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#039;" }[m]));
  const money=(n)=>{const m=Math.round(n); return (m<0? "-$"+Math.abs(m): "$"+m);};

  function initJeopardy(){
    $("#gameTitle").textContent = GAME.title;
    $("#gameSubtitle").textContent = GAME.subtitle;

    GAME.teams.forEach(t=> state.scores[t]=0);
    state.activeTeam = GAME.teams[0];

    renderScoreboard(); renderBoard(); bindUI();
  }

  function renderScoreboard(){
    scoreboardEl.innerHTML = `
      <div class="teams">
        ${GAME.teams.map(t=>`
          <div class="team">
            <div class="name">
              <span>${esc(t)}</span>
              <span class="score" id="score-${cssId(t)}">${money(state.scores[t])}</span>
            </div>
            <div class="adj">
              <button class="good" data-adj="+100" data-team="${esc(t)}">+100</button>
              <button class="danger" data-adj="-100" data-team="${esc(t)}">-100</button>
              <button class="secondary" data-setactive="${esc(t)}">Active</button>
            </div>
          </div>
        `).join("")}
      </div>
      <div class="pill">Active team: <strong style="color:var(--text)">${esc(state.activeTeam)}</strong></div>
    `;

    scoreboardEl.querySelectorAll("button[data-adj]").forEach(b=>{
      b.onclick=()=>{ state.scores[b.dataset.team]+=parseInt(b.dataset.adj,10); updateScores(); };
    });
    scoreboardEl.querySelectorAll("button[data-setactive]").forEach(b=>{
      b.onclick=()=>{ state.activeTeam=b.dataset.setactive; renderScoreboard(); if(qOverlay.classList.contains("show")) renderQTeams(); };
    });
  }

  function renderBoard(){
    boardEl.style.gridTemplateColumns = `repeat(${GAME.categories.length}, minmax(140px,1fr))`;
    const cells=[];
    GAME.categories.forEach(cat=>cells.push(`<div class="cell category">${esc(cat.name)}</div>`));
    for(let r=0;r<GAME.values.length;r++){
      for(let c=0;c<GAME.categories.length;c++){
        const used = state.used.has(keyOf(c,r));
        const clue = GAME.categories[c].clues[r];
        const show = state.showDD && clue.dd;
        cells.push(`
          <div class="cell question ${used?"used":""}" data-c="${c}" data-r="${r}" tabindex="0">
            ${used? "" : "$"+GAME.values[r]}
            ${show? `<span class="badge">DD</span>`:""}
          </div>
        `);
      }
    }
    boardEl.innerHTML = cells.join("");
    boardEl.querySelectorAll(".cell.question").forEach(cell=>{
      const open=()=>{
        const c=+cell.dataset.c, r=+cell.dataset.r;
        if(state.used.has(keyOf(c,r))) return;
        openQuestion(c,r);
      };
      cell.onclick=open;
      cell.onkeydown=(e)=>{ if(e.key==="Enter"||e.key===" "){e.preventDefault();open();}};
    });
  }

  function openQuestion(c,r){
    const cat=GAME.categories[c], clue=cat.clues[r], value=GAME.values[r];
    state.current={c,r,value,clue};
    $("#qTitle").textContent=cat.name;
    $("#qMeta").textContent=`For ${money(value)} • Active team: ${state.activeTeam}`;
    $("#qPrompt").textContent=clue.q;
    $("#qAnswer").textContent=clue.a;
    $("#qReveal").classList.remove("show");
    $("#qValuePill").textContent=money(value);
    $("#qDDPill").style.display=clue.dd?"inline-flex":"none";
    renderQTeams();
    qOverlay.classList.add("show");
    
    // Play sound effects
    if(clue.dd) {
      playSound('dailyDouble');
    } else {
      playSound('questionSong');
    }
  }

  function renderQTeams(){
    const wrap=$("#qTeams");
    wrap.innerHTML = GAME.teams.map(t=>`
      <button class="${t===state.activeTeam?"":"secondary"}" data-team="${esc(t)}">${esc(t)} ${t===state.activeTeam?"✓":""}</button>
    `).join("");
    wrap.querySelectorAll("button").forEach(b=>{
      b.onclick=()=>{
        state.activeTeam=b.dataset.team;
        $("#qMeta").textContent=`For ${money(state.current.value)} • Active team: ${state.activeTeam}`;
        renderScoreboard(); renderQTeams();
      };
    });
  }

  function closeQ(){ 
    qOverlay.classList.remove("show"); 
    state.current=null;
    // Stop question song when closing
    stopSound('questionSong');
  }
  function markUsed(c,r){
    state.used.add(keyOf(c,r));
    const tile = boardEl.querySelector(`.cell.question[data-c="${c}"][data-r="${r}"]`);
    if(tile){ tile.classList.add("used"); tile.textContent=""; }
  }
  function updateScores(){
    GAME.teams.forEach(t=>{
      const el=document.getElementById(`score-${cssId(t)}`);
      if(el) el.textContent=money(state.scores[t]);
    });
  }

  function applyResult(correct){
    if(!state.current) return;
    const {c,r,value,clue}=state.current;
    let delta=value;
    if(clue.dd){
      const w = Number(prompt(`Daily Double! Enter wager for ${state.activeTeam}:`, String(value)));
      if(Number.isFinite(w) && w>=0) delta=Math.round(w);
    }
    state.scores[state.activeTeam] += correct ? delta : -delta;
    updateScores();
    markUsed(c,r);
    
    // Play sound effect
    playSound(correct ? 'correct' : 'incorrect');
    
    closeQ();
  }

  function openFinal(){
    $("#fMeta").textContent = GAME.final.category;
    $("#fPrompt").textContent = GAME.final.q;
    $("#fAnswer").textContent = GAME.final.a;
    $("#fReveal").classList.remove("show");
    
    // Play Final Jeopardy sound
    playSound('finalJeopardy');

    const grid=$("#finalGrid");
    grid.innerHTML = GAME.teams.map(t=>`
      <div class="final-card" data-team="${esc(t)}">
        <div style="display:flex;justify-content:space-between;align-items:center;gap:8px">
          <div class="tname">${esc(t)}</div>
          <div class="tscore">${money(state.scores[t])}</div>
        </div>
        <label>Wager</label>
        <input type="number" min="0" step="1" inputmode="numeric" placeholder="e.g., 500" value="${state.final.wagers[t] ?? ""}">
        <div style="display:flex;gap:10px;margin-top:10px;flex-wrap:wrap">
          <button class="good" data-correct="1">Correct</button>
          <button class="danger" data-correct="0">Wrong</button>
          <span class="pill" style="margin-left:auto" id="finalMark-${cssId(t)}">${
            state.final.correct[t]===true ? "Marked: Correct" :
            state.final.correct[t]===false ? "Marked: Wrong" : "Not marked"
          }</span>
        </div>
      </div>
    `).join("");

    grid.querySelectorAll(".final-card").forEach(card=>{
      const team=card.dataset.team;
      const input=card.querySelector("input");
      input.oninput=()=>{ const v=Number(input.value); state.final.wagers[team]=Number.isFinite(v)?Math.max(0,Math.round(v)):0; };
      card.querySelectorAll("button[data-correct]").forEach(btn=>{
        btn.onclick=()=>{
          state.final.correct[team]=btn.dataset.correct==="1";
          const mark=document.getElementById(`finalMark-${cssId(team)}`);
          if(mark) mark.textContent = state.final.correct[team] ? "Marked: Correct" : "Marked: Wrong";
        };
      });
    });

    fOverlay.classList.add("show");
  }

  function applyFinal(){
    GAME.teams.forEach(t=>{
      const w=Number(state.final.wagers[t] ?? 0);
      const ok=state.final.correct[t];
      if(ok===true) state.scores[t]+=w;
      else if(ok===false) state.scores[t]-=w;
    });
    updateScores();
    renderScoreboard();
    alert("Final wagers applied.");
  }

  /* =========================
     SOUND EFFECTS
     ========================= */
  const audioElements = {
    theme: document.getElementById('audioTheme'),
    correct: document.getElementById('audioCorrect'),
    incorrect: document.getElementById('audioIncorrect'),
    dailyDouble: document.getElementById('audioDailyDouble'),
    finalJeopardy: document.getElementById('audioFinalJeopardy'),
    questionSong: document.getElementById('audioQuestionSong'),
    timesUp: document.getElementById('audioTimesUp')
  };

  function playSound(soundName) {
    const audio = audioElements[soundName];
    if (audio) {
      audio.currentTime = 0; // Reset to start
      audio.play().catch(err => console.warn(`Could not play ${soundName}:`, err));
    }
  }

  function stopSound(soundName) {
    const audio = audioElements[soundName];
    if (audio) {
      audio.pause();
      audio.currentTime = 0;
    }
  }

  function bindUI(){
    $("#btnToggleDD").onclick=()=>{ state.showDD=!state.showDD; $("#btnToggleDD").textContent=state.showDD?"Host: Hide DD":"Host: Show DD"; renderBoard(); };
    $("#btnReset").onclick=()=>{ if(!confirm("Reset board & scores?"))return; state.used=new Set(); GAME.teams.forEach(t=>state.scores[t]=0); state.final={wagers:{},correct:{}}; renderScoreboard(); renderBoard(); };
    $("#btnFinal").onclick=openFinal;

    $("#btnCloseQ").onclick=closeQ;
    qOverlay.onclick=(e)=>{ if(e.target===qOverlay) closeQ(); };
    $("#btnReveal").onclick=()=>$("#qReveal").classList.toggle("show");
    $("#btnCorrect").onclick=()=>applyResult(true);
    $("#btnWrong").onclick=()=>applyResult(false);

    $("#btnCloseF").onclick=()=>fOverlay.classList.remove("show");
    fOverlay.onclick=(e)=>{ if(e.target===fOverlay) fOverlay.classList.remove("show"); };
    $("#btnRevealFinal").onclick=()=>$("#fReveal").classList.toggle("show");
    $("#btnApplyFinal").onclick=applyFinal;

    // Start button handler
    const startButton = document.getElementById('startButton');
    const splashScreen = document.getElementById('splashScreen');
    if (startButton && splashScreen) {
      startButton.onclick = () => {
        // Set flag to allow game initialization
        gameStarted = true;
        
        // Hide splash screen
        splashScreen.classList.add('hidden');
        document.body.classList.add('game-started');
        
        // Now initialize the game (setup teams, etc.)
        // This is the ONLY place setupTeams() should be called
        setupTeams();
        initJeopardy();
        createRoom();
      };
    }
  }

  // START - Initialize UI and start theme music
  // CRITICAL: Don't initialize game until start button is clicked
  // setupTeams() MUST ONLY be called from the start button handler above
  
  bindUI();
  
  // Start theme music when splash screen appears
  // Try multiple approaches to handle autoplay restrictions
  function startThemeMusic() {
    const themeAudio = document.getElementById('audioTheme');
    if (themeAudio) {
      themeAudio.volume = 0.7;
      const playPromise = themeAudio.play();
      if (playPromise !== undefined) {
        playPromise.catch(err => {
          console.log('Theme music autoplay blocked, will play on first click');
          // Play on first user interaction
          const playOnClick = () => {
            themeAudio.play().catch(() => {});
            document.removeEventListener('click', playOnClick);
            document.removeEventListener('touchstart', playOnClick);
          };
          document.addEventListener('click', playOnClick, { once: true });
          document.addEventListener('touchstart', playOnClick, { once: true });
        });
      }
    }
  }
  
  // Try to start music when DOM is ready
  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', () => {
      setTimeout(startThemeMusic, 200);
    });
  } else {
    // DOM already loaded
    setTimeout(startThemeMusic, 500);
  }
</script>
</body>
</html>
